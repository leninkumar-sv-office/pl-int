<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zerodha Connect ‚Äî Stock Dashboard</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f0f23; color: #e0e0e0; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
  .container { max-width: 520px; width: 100%; padding: 2rem; }
  h1 { font-size: 1.5rem; margin-bottom: 1.5rem; color: #fff; }
  .card { background: #1a1a2e; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.2rem; border: 1px solid #2a2a4a; }
  .card h2 { font-size: 1rem; color: #8888aa; margin-bottom: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
  .status-row { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; }
  .status-label { color: #aaa; font-size: 0.9rem; }
  .status-value { font-weight: 600; font-size: 0.9rem; }
  .status-ok { color: #4ade80; }
  .status-warn { color: #facc15; }
  .status-err { color: #f87171; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
  .badge-green { background: #166534; color: #4ade80; }
  .badge-red { background: #7f1d1d; color: #f87171; }
  .badge-yellow { background: #713f12; color: #facc15; }
  .error-box { background: #2d1b1b; border: 1px solid #7f1d1d; border-radius: 8px; padding: 0.8rem; margin-top: 0.8rem; font-size: 0.85rem; color: #fca5a5; word-break: break-all; }
  .btn { display: inline-block; padding: 0.7rem 1.5rem; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; text-decoration: none; transition: all 0.2s; }
  .btn-primary { background: #3b82f6; color: #fff; }
  .btn-primary:hover { background: #2563eb; }
  .btn-green { background: #16a34a; color: #fff; }
  .btn-green:hover { background: #15803d; }
  .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  input[type="text"] { width: 100%; padding: 0.7rem; border: 1px solid #3a3a5a; border-radius: 8px; background: #0f0f23; color: #e0e0e0; font-size: 0.9rem; font-family: monospace; }
  input[type="text"]:focus { outline: none; border-color: #3b82f6; }
  .input-group { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
  .input-group input { flex: 1; }
  .hint { font-size: 0.8rem; color: #666; margin-top: 0.4rem; }
  .msg { padding: 0.7rem; border-radius: 8px; margin-top: 0.8rem; font-size: 0.9rem; display: none; }
  .msg-ok { background: #052e16; border: 1px solid #166534; color: #4ade80; }
  .msg-err { background: #2d1b1b; border: 1px solid #7f1d1d; color: #fca5a5; }
  .divider { border-top: 1px solid #2a2a4a; margin: 1rem 0; }
  .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; }
  a { color: #60a5fa; }
  .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.6s linear infinite; vertical-align: middle; margin-left: 6px; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="container">
  <h1>üîó Zerodha Kite Connect</h1>

  <!-- Status Card -->
  <div class="card" id="statusCard">
    <h2>Connection Status</h2>
    <div class="status-row">
      <span class="status-label">API Key</span>
      <span id="apiKeyStatus" class="status-value">Loading...</span>
    </div>
    <div class="status-row">
      <span class="status-label">API Secret</span>
      <span id="apiSecretStatus" class="status-value">Loading...</span>
    </div>
    <div class="status-row">
      <span class="status-label">Access Token</span>
      <span id="tokenStatus" class="status-value">Loading...</span>
    </div>
    <div class="status-row">
      <span class="status-label">Session</span>
      <span id="sessionStatus" class="status-value">Loading...</span>
    </div>
    <div id="errorBox" class="error-box" style="display:none"></div>
  </div>

  <!-- Login Card -->
  <div class="card" id="loginCard">
    <h2>Refresh Token</h2>
    <p style="font-size:0.9rem; color:#aaa; margin-bottom:0.8rem;">
      Kite access tokens expire daily at ~6 AM IST. You need to re-login each trading day.
    </p>

    <div id="oauthSection">
      <a id="loginBtn" class="btn btn-primary" href="#">
        Login with Zerodha
      </a>
      <p class="hint">Opens Kite login in this window. After login, you'll be redirected back here.</p>
    </div>

    <div id="noSecretHint" style="display:none; margin-bottom:1rem;">
      <p style="font-size:0.85rem; color:#facc15;">
        ‚ö†Ô∏è API Secret not set. Add <code>ZERODHA_API_SECRET=xxx</code> to your .env to enable one-click login.
        <br>For now, paste your access token manually below.
      </p>
    </div>

    <div class="divider"></div>

    <p style="font-size:0.85rem; color:#888; margin-bottom:0.5rem;">Or paste access token manually:</p>
    <div class="input-group">
      <input type="text" id="tokenInput" placeholder="Paste access token here...">
      <button class="btn btn-green btn-sm" id="setTokenBtn" onclick="setToken()">Set</button>
    </div>
    <p class="hint">
      Get your token from <a href="https://kite.trade/connect/login" target="_blank">Kite Developer Console</a>
      or use a token generator tool.
    </p>
    <div id="tokenMsg" class="msg"></div>
  </div>

  <!-- Test Card -->
  <div class="card">
    <h2>Test Connection</h2>
    <div class="actions">
      <button class="btn btn-primary btn-sm" onclick="testConnection()">Test API</button>
      <button class="btn btn-sm" style="background:#374151;color:#e0e0e0;" onclick="triggerRefresh()">Force Price Refresh</button>
    </div>
    <div id="testMsg" class="msg"></div>
  </div>

  <!-- Back to Dashboard -->
  <div style="text-align:center; margin-top:1rem;">
    <a href="/" style="color:#60a5fa; font-size:0.9rem;">‚Üê Back to Dashboard</a>
  </div>
</div>

<script>
const API = '';  // Same origin

async function loadStatus() {
  try {
    const resp = await fetch(API + '/api/zerodha/status');
    const data = await resp.json();

    // API Key
    const apiKeyEl = document.getElementById('apiKeyStatus');
    if (data.configured) {
      apiKeyEl.innerHTML = `<span class="badge badge-green">${data.api_key_prefix}</span>`;
    } else {
      apiKeyEl.innerHTML = `<span class="badge badge-red">Not Set</span>`;
    }

    // API Secret
    const secretEl = document.getElementById('apiSecretStatus');
    if (data.has_api_secret) {
      secretEl.innerHTML = `<span class="badge badge-green">Set</span>`;
      document.getElementById('oauthSection').style.display = 'block';
      document.getElementById('noSecretHint').style.display = 'none';
    } else {
      secretEl.innerHTML = `<span class="badge badge-yellow">Not Set</span>`;
      document.getElementById('oauthSection').style.display = 'none';
      document.getElementById('noSecretHint').style.display = 'block';
    }

    // Token
    const tokenEl = document.getElementById('tokenStatus');
    if (data.has_access_token) {
      tokenEl.innerHTML = `<span class="badge badge-green">${data.token_prefix}</span>`;
    } else {
      tokenEl.innerHTML = `<span class="badge badge-red">Not Set</span>`;
    }

    // Session
    const sessEl = document.getElementById('sessionStatus');
    if (data.session_valid) {
      sessEl.innerHTML = `<span class="badge badge-green">Valid</span>`;
    } else if (data.auth_failed) {
      sessEl.innerHTML = `<span class="badge badge-red">Expired / Invalid</span>`;
    } else if (data.has_access_token) {
      sessEl.innerHTML = `<span class="badge badge-yellow">Untested</span>`;
    } else {
      sessEl.innerHTML = `<span class="badge badge-red">No Token</span>`;
    }

    // Error
    const errBox = document.getElementById('errorBox');
    if (data.last_error) {
      errBox.textContent = data.last_error;
      errBox.style.display = 'block';
    } else {
      errBox.style.display = 'none';
    }

    // Login URL
    if (data.configured) {
      const loginResp = await fetch(API + '/api/zerodha/login-url');
      const loginData = await loginResp.json();
      document.getElementById('loginBtn').href = loginData.login_url;
    }
  } catch (e) {
    console.error('Failed to load status:', e);
  }
}

async function setToken() {
  const input = document.getElementById('tokenInput');
  const token = input.value.trim();
  if (!token) return;

  const btn = document.getElementById('setTokenBtn');
  btn.disabled = true;
  btn.innerHTML = 'Setting...<span class="spinner"></span>';
  const msg = document.getElementById('tokenMsg');

  try {
    const resp = await fetch(API + '/api/zerodha/set-token', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({access_token: token}),
    });
    const data = await resp.json();

    if (data.valid) {
      msg.className = 'msg msg-ok';
      msg.textContent = '‚úì Token set and validated successfully!';
    } else {
      msg.className = 'msg msg-ok';
      msg.textContent = '‚úì Token saved. ' + (data.message || 'Will be validated on next API call.');
    }
    msg.style.display = 'block';
    input.value = '';
    setTimeout(loadStatus, 500);
  } catch (e) {
    msg.className = 'msg msg-err';
    msg.textContent = '‚úó Failed to set token: ' + e.message;
    msg.style.display = 'block';
  }
  btn.disabled = false;
  btn.textContent = 'Set';
}

async function testConnection() {
  const msg = document.getElementById('testMsg');
  msg.className = 'msg msg-ok';
  msg.textContent = 'Testing...';
  msg.style.display = 'block';

  try {
    const resp = await fetch(API + '/api/zerodha/validate');
    const data = await resp.json();
    if (data.valid) {
      msg.className = 'msg msg-ok';
      msg.textContent = '‚úì Connection working! ' + (data.message || '');
    } else {
      msg.className = 'msg msg-err';
      msg.textContent = '‚úó ' + (data.message || 'Connection failed');
    }
    setTimeout(loadStatus, 500);
  } catch (e) {
    msg.className = 'msg msg-err';
    msg.textContent = '‚úó Error: ' + e.message;
  }
}

async function triggerRefresh() {
  const msg = document.getElementById('testMsg');
  msg.className = 'msg msg-ok';
  msg.textContent = 'Triggering refresh...';
  msg.style.display = 'block';

  try {
    const resp = await fetch(API + '/api/prices/refresh', {method: 'POST'});
    const data = await resp.json();
    msg.className = 'msg msg-ok';
    msg.textContent = '‚úì ' + (data.message || 'Refresh started');
  } catch (e) {
    msg.className = 'msg msg-err';
    msg.textContent = '‚úó Error: ' + e.message;
  }
}

// Handle ?auth=success|failed from OAuth callback
const params = new URLSearchParams(window.location.search);
if (params.get('auth') === 'success') {
  window.history.replaceState({}, '', '/api/zerodha/login');
  setTimeout(() => {
    const msg = document.getElementById('tokenMsg');
    msg.className = 'msg msg-ok';
    msg.textContent = '‚úì Zerodha login successful! Token has been set.';
    msg.style.display = 'block';
    // Refresh the status card to show the new valid session
    loadStatus();
  }, 300);
}
if (params.get('auth') === 'failed') {
  window.history.replaceState({}, '', '/api/zerodha/login');
  setTimeout(() => {
    const msg = document.getElementById('tokenMsg');
    msg.className = 'msg msg-err';
    msg.textContent = '‚úó Login failed: ' + (params.get('error') || 'Unknown error');
    msg.style.display = 'block';
  }, 300);
}

// Token from URL hash (some token generators put it there)
if (window.location.hash) {
  const hashToken = window.location.hash.replace('#', '');
  if (hashToken.length > 20) {
    document.getElementById('tokenInput').value = hashToken;
    window.location.hash = '';
  }
}

// Enter key on token input
document.getElementById('tokenInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') setToken();
});

loadStatus();
</script>
</body>
</html>
